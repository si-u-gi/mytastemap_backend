<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />

  <!-- âœ… ì¹´ì¹´ì˜¤ë§µ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=28d73fe896f3bb8829428aac2c341cf7&autoload=false"></script>

  <style>
    * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #loading {
      position: absolute;
      inset: 0;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      font-size: 14px;
    }

    /* âœ… ë°˜ì‘í˜• í•„í„° ë°•ìŠ¤ */
    #filter-box {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 10;
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    #filter-box input {
      width: 48px;
    }

    #filter-box button {
      margin-left: 6px;
      padding: 4px 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .marker-label {
      background: white;
      padding: 4px;
      font-size: 11px;
      border-radius: 4px;
      white-space: nowrap;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="map-wrapper">
    <div id="loading">ì§€ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

    <div id="filter-box">
      â­ â‰¥ <input id="minRating" type="number" step="0.1" value="0">
      ğŸ“ â‰¥ <input id="minReview" type="number" value="0">
      <button onclick="applyFilter()">ì ìš©</button>
      <button onclick="locateMe()">ğŸ“</button>
    </div>

    <div id="map"></div>
  </div>

  <script>
    let map;
    let markers = [];
    let overlays = [];
    let allStores = [];
    let mapReady = false;
    let myMarker = null;

    /* âœ… ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” (iOS í•„ìˆ˜ íŒ¨í„´) */
    kakao.maps.load(() => {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.4979, 127.0276),
        level: 4
      });

      mapReady = true;
      document.getElementById('loading').style.display = 'none';

      locateMe(); // ğŸ”¥ ì§€ë„ ë¡œë“œ í›„ ë‚´ ìœ„ì¹˜
    });

    /* âœ… Flutter â†’ JS */
    function drawMarkers(stores) {
      if (!mapReady) return;

      allStores = stores;
      render(stores.slice(0, 120)); // ğŸ”¥ ëª¨ë°”ì¼ ì„±ëŠ¥ ìµœì í™”
    }

    function render(stores) {
      clearAll();

      stores.forEach(store => {
        const pos = new kakao.maps.LatLng(store.lat, store.lng);

        const marker = new kakao.maps.Marker({ position: pos });
        marker.setMap(map);
        markers.push(marker);

        const overlay = new kakao.maps.CustomOverlay({
          position: pos,
          yAnchor: 1.6,
          content: `
            <div class="marker-label">
              <b>${store.name}</b><br/>
              â­ ${store.rating ?? 0} Â· ğŸ“ ${store.reviewCount ?? 0}
            </div>
          `
        });

        overlay.setMap(map);
        overlays.push(overlay);
      });
    }

    function clearAll() {
      markers.forEach(m => m.setMap(null));
      overlays.forEach(o => o.setMap(null));
      markers = [];
      overlays = [];
    }

    function applyFilter() {
      const minRating = Number(minRating.value);
      const minReview = Number(minReview.value);

      render(
        allStores.filter(s =>
          (s.rating ?? 0) >= minRating &&
          (s.reviewCount ?? 0) >= minReview
        ).slice(0, 120)
      );
    }

    /* âœ… ë‚´ ìœ„ì¹˜ í‘œì‹œ */
    function locateMe() {
      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(
        pos => {
          const latlng = new kakao.maps.LatLng(
            pos.coords.latitude,
            pos.coords.longitude
          );

          map.setCenter(latlng);

          if (myMarker) myMarker.setMap(null);

          myMarker = new kakao.maps.Marker({
            position: latlng,
            image: new kakao.maps.MarkerImage(
              "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
              new kakao.maps.Size(24, 35)
            )
          });

          myMarker.setMap(map);
        },
        err => console.log("ìœ„ì¹˜ ì‹¤íŒ¨", err),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    }
  </script>
</body>
</html>
